<!DOCTYPE html>
<html>
<head>
<style type="text/css">
  .loginStatus {text-align:right;}
  .loginItem {padding-left: 5px;}
  #qrcodeForm{border:1px solid #999; -webkit-box-shadow: 0px 0px 6px #CCC; background-color:#FFF; width:500px; height:580px; position: absolute; top:25px; left:10%; margin-left:-50px; padding:10px; border-radius:4px;}
</style>

</head>
<body>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script type="text/javascript"    src="/jquery.qrcode.min.js"></script>

<div class="loginStatus">
  <a href="" id="login" class="loginItem"> login </a>
  <a href="/logout" id="logout" class="loginItem">logout </a>
</div>

<div id="qrcodeForm">
    <p>Scan QR Code to login or</p>
    <p>
      <a href="" id="loginBackdoor"> backdoor login </a>
        <a href="" id="loginMobile" class="loginStatus"> mobile agent login </a>
    </p>
    <div id="qrcode"></div>
</div>


<H1 id='title'>Sample App</H1>

<hr>

<table id="profileTable"> </table>

<script type="text/javascript">

function onReady() {

  $('#qrcodeForm').hide()
  $('#logout').hide()

  $('#login').click( function () {
    $.get( '/login', function ( data, status ) {
      if (status == "success" && !data.error && data.result && data.result.agentRequest) {   // TBD, deal with error
        var agentURL = 'a2p3://token?request=' + data.result.agentRequest + '&state=' + data.result.state
        var backdoorURL = 'http://setup.a2p3.net/backdoor/login?request=' + data.result.agentRequest
        $('#loginMobile').attr( 'href', agentURL )
        $('#loginBackdoor').attr( 'href', backdoorURL )
        $('#qrcode').empty()
        $('#qrcodeForm').fadeIn('fast')
        // $('#qrcode').qrcode( {width: 500, height: 500, text: agentURL } )


var testQR = 'a2p3://token?request=eyJ0eXAiOiJKV1MiLCJhbGciOiJIUzUxMiIsImtpZCI6InpyQWp2dGRLQUkzZ0NZRW0ifQ.eyJpc3MiOiJleGFtcGxlLmEycDMuY29tIiwiYXVkIjoiaXguYTJwMy5uZXQiLCJpYXQiOjEzNTg3ODQ0NzAsInJlcXVlc3QuYTJwMy5vcmciOnsicmVzb3VyY2VzIjpbImh0dHA6Ly9lbWFpbC5hMnAzLm5ldC9zY29wZS9kZWZhdWx0IiwiaHR0cDovL3Blb3BsZS5hMnAzLm5ldC9zY29wZS9kZXRhaWxzIiwiaHR0cDovL3NpLmEycDMubmV0L3Njb3BlL251bWJlciIsImh0dHA6Ly9oZWFsdGguYTJwMy5uZXQvc2NvcGUvcHJv'

$('#qrcode').qrcode( {width: 500, height: 500, text: testQR } )

// TBD -- need to query to see if we are logged in from mobile agent, and then reload page -- or load profile
// put profile loading into a separate function, then can call on load, and on successful login

      }
    })
    return false
  })

  $.get( '/profile', function ( data, status ) {
    if (status == "success" && !data.error && data.result ) {   // TBD, deal with error
      $('#logout').show()
      $('#login').hide()
      var profile = data.result
      Object.keys( profile ).forEach( function ( rs ) {
        $('#profileTable').append('<tr><td>' + rs + '</td><td></td><td></td></tr>')
        Object.keys( profile[rs] ).forEach( function ( item ) {
          $('#profileTable').append('<tr><td></td><td>' + item + '</td><td>' + profile[rs][item] + '</td></tr>')
        })
      })
    }
  })

} // onReady

$(document).ready(onReady)

</script>

</body>
</html>